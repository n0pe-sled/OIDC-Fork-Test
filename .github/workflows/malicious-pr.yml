name: Debug AWS OIDC
on:
  pull_request:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Print GitHub Context
        run: |
          echo "Repository: ${{ github.repository }}"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "Expected 'sub' claim:"
          echo "repo:${{ github.repository }}:pull_request"

      - name: Request OIDC Token
        id: token
        run: |
          # Request token from GitHub
          TOKEN=$(curl -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sts.amazonaws.com" | jq -r '.value')
          echo "Got token (first 50 chars): ${TOKEN:0:50}..."
          
          # Decode token to see claims (without verification)
          echo ""
          echo "Token payload:"
          echo $TOKEN | cut -d. -f2 | base64 -d 2>/dev/null | jq .

      - name: Try AWS Authentication
        uses: aws-actions/configure-aws-credentials@v4
        continue-on-error: true
        id: aws-auth
        with:
          role-to-assume: arn:aws:iam::851725637490:role/GithubActionsTest
          aws-region: us-east-1

      - name: Show Result
        run: |
          if [ "${{ steps.aws-auth.outcome }}" == "success" ]; then
            echo "✅ AWS authentication succeeded!"
            aws sts get-caller-identity
          else
            echo "❌ AWS authentication failed"
            echo "This means either:"
            echo "  1. OIDC provider not set up correctly"
            echo "  2. Repository name mismatch"
            echo "  3. Trust policy issue"
          fi
